<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus // Messaging</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;800&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        :root { --bg: #030303; --panel: #0a0a0a; --accent: #00A2FF; --border: #1a1a1a; --text-dim: #444; --glow: 0 0 10px rgba(0, 162, 255, 0.2); }
        body { background: var(--bg); color: #fff; font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar - Futuristic Terminal */
        .sidebar { width: 300px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .side-header { padding: 25px; border-bottom: 1px solid var(--border); font-weight: 800; color: var(--accent); font-size: 0.8rem; letter-spacing: 2px; }
        
        .nav-item { padding: 15px 25px; cursor: pointer; border-bottom: 1px solid #080808; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
        .nav-item:hover { background: #111; }
        .nav-item.active { background: #001524; border-left: 3px solid var(--accent); }
        .nav-item img { width: 32px; height: 32px; border-radius: 4px; border: 1px solid var(--border); }
        .nav-item .u-info { font-size: 0.85rem; font-weight: 800; }
        .nav-item .u-status { font-size: 0.6rem; color: var(--text-dim); font-family: 'JetBrains Mono'; }

        /* Chat Main */
        .chat-main { flex: 1; display: flex; flex-direction: column; background: #000; position: relative; }
        .chat-header { padding: 15px 25px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: space-between; }
        .chat-title { font-weight: 800; font-size: 0.9rem; }

        #messages { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 15px; }
        
        /* Message Bubbles */
        .msg { max-width: 60%; padding: 12px 16px; border-radius: 4px; font-size: 0.9rem; line-height: 1.5; position: relative; }
        .msg.me { align-self: flex-end; background: var(--accent); color: #000; font-weight: 600; border-bottom-right-radius: 0; box-shadow: var(--glow); }
        .msg.not-me { align-self: flex-start; background: var(--panel); border: 1px solid var(--border); border-bottom-left-radius: 0; color: #ccc; }
        .msg-time { font-size: 0.5rem; opacity: 0.5; margin-top: 5px; display: block; text-align: right; font-family: 'JetBrains Mono'; }

        /* Input Area */
        .input-area { padding: 20px; border-top: 1px solid var(--border); background: #050505; }
        .input-box { background: #000; border: 1px solid var(--border); border-radius: 6px; display: flex; padding: 5px; align-items: center; }
        input { flex: 1; background: transparent; border: none; color: #fff; padding: 12px; outline: none; font-family: inherit; }
        .send-btn { background: var(--accent); color: #000; border: none; padding: 8px 20px; border-radius: 4px; font-weight: 800; cursor: pointer; font-size: 0.7rem; }

        /* Back to Feed */
        .back-link { color: var(--text-dim); text-decoration: none; font-size: 0.7rem; font-weight: 800; transition: 0.2s; }
        .back-link:hover { color: #fff; }

        #login-gate { position: fixed; inset: 0; background: #000; z-index: 999; display: none; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="login-gate">
        <a href="#" id="auth-link" style="background:#fff; color:#000; padding:15px 30px; border-radius:4px; text-decoration:none; font-weight:800;">VERIFY_OAUTH</a>
    </div>

    <div class="sidebar">
        <div class="side-header">COMMUNICATIONS_LOG</div>
        <div class="nav-item active" onclick="setMode('global')">
            <div style="width:32px; height:32px; background:var(--accent); border-radius:4px; display:flex; align-items:center; justify-content:center; color:#000; font-weight:800;">#</div>
            <div class="u-info">General Hub<div class="u-status">PUBLIC_DATA_STREAM</div></div>
        </div>
        <div style="font-size:0.6rem; color:var(--text-dim); margin: 20px 0 10px 25px; letter-spacing: 2px;">DIRECT_ENCRYPTION</div>
        <div id="dm-list"></div>
    </div>

    <div class="chat-main">
        <div class="chat-header">
            <div class="chat-title" id="chat-title"># GENERAL-HUB</div>
            <a href="threads.html" class="back-link">BACK_TO_FEED</a>
        </div>
        <div id="messages"></div>
        <div class="input-area">
            <div class="input-box">
                <input type="text" id="msgInput" placeholder="Enter transmission...">
                <button class="send-btn" onclick="send()">SEND</button>
            </div>
        </div>
    </div>

    <script>
        const ably = new Ably.Realtime('I2GocA.2XM7TQ:nuJQeyu7st5NRAjpGZKS00fjwc4qbCRGioyS_ERGTdc');
        const globalChan = ably.channels.get('global-hub');
        const me = localStorage.getItem('rbx_user');
        let mode = 'global'; 
        let targetUser = null;

        window.onload = () => {
            if(!me) {
                document.getElementById('login-gate').style.display = 'flex';
                return;
            }
            init();
            
            // Check if we came from a profile to start a DM
            const urlParams = new URLSearchParams(window.location.search);
            const dmTarget = urlParams.get('dm');
            if(dmTarget) setMode('dm', dmTarget);
        };

        function init() {
            // Subscribe to Global
            globalChan.subscribe('msg', (m) => {
                if(mode === 'global') render(m.data);
                if(m.data.user !== me) updateDMList(m.data.user, m.data.pic);
            });

            // Subscribe to Personal DM Channel
            ably.channels.get('dm-' + me).subscribe('priv', (m) => {
                updateDMList(m.data.user, m.data.pic);
                if(mode === 'dm' && targetUser === m.data.user) render(m.data);
            });

            // Load History
            globalChan.history({limit: 30}, (err, page) => {
                if(!err) page.items.reverse().forEach(m => render(m.data));
            });
        }

        function updateDMList(u, p) {
            if(document.getElementById('dm-' + u)) return;
            const item = document.createElement('div');
            item.id = 'dm-' + u;
            item.className = 'nav-item';
            item.onclick = () => setMode('dm', u);
            item.innerHTML = `
                <img src="${p}">
                <div class="u-info">${u}<div class="u-status">ENCRYPTED_LINE</div></div>
            `;
            document.getElementById('dm-list').appendChild(item);
        }

        function setMode(m, u = null) {
            mode = m;
            targetUser = u;
            document.getElementById('messages').innerHTML = '';
            document.getElementById('chat-title').innerText = m === 'global' ? '# GENERAL-HUB' : '>> PRIVATE_SESSION: ' + u.toUpperCase();
            
            // Highlight active in sidebar
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(m === 'dm') document.getElementById('dm-' + u)?.classList.add('active');

            // Load DM history if needed (Advanced: requires persistent DB, but Ably keeps recent)
        }

        function send() {
            const input = document.getElementById('msgInput');
            if(!input.value.trim()) return;

            const data = {
                user: me,
                text: input.value,
                pic: localStorage.getItem('rbx_pic'),
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            };

            if(mode === 'global') {
                globalChan.publish('msg', data);
            } else {
                ably.channels.get('dm-' + targetUser).publish('priv', data);
                render(data); // Local render for own DM
            }
            input.value = '';
        }

        function render(d) {
            const mBox = document.getElementById('messages');
            const isMe = d.user === me;
            const div = document.createElement('div');
            div.className = isMe ? 'msg me' : 'msg not-me';
            
            div.innerHTML = `
                ${!isMe ? `<div style="font-size:0.6rem; color:var(--accent); font-weight:800; margin-bottom:5px;">${d.user.toUpperCase()}</div>` : ''}
                ${d.text}
                <span class="msg-time">${d.time || 'NOW'}</span>
            `;
            
            mBox.appendChild(div);
            mBox.scrollTop = mBox.scrollHeight;
        }

        document.getElementById('msgInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') send(); });
    </script>
</body>
</html>
