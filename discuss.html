<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Adiyan Hub | Discussions</title>
    <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>
    <style>
        body { background: #050505; color: white; font-family: sans-serif; margin: 0; }
        .nav { padding: 20px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; }
        .chat-box { max-width: 800px; margin: 50px auto; background: #111; padding: 20px; border-radius: 15px; }
        #msgs { height: 300px; overflow-y: auto; border-bottom: 1px solid #222; margin-bottom: 20px; padding: 10px; }
        .msg { margin-bottom: 10px; font-size: 0.9rem; }
        .input-area { display: flex; gap: 10px; }
        input { flex: 1; padding: 10px; background: #222; border: 1px solid #333; color: white; border-radius: 5px; }
        button { padding: 10px 20px; cursor: pointer; background: #fff; color: #000; border: none; font-weight: bold; border-radius: 5px; }
        #overlay { position: fixed; inset: 0; background: #000; display: flex; align-items: center; justify-content: center; z-index: 100; }
    </style>
</head>
<body>

    <div id="overlay">
        <button onclick="login()" style="background:#00A2FF; color:white; padding:20px 40px; font-size:1.2rem;">LOGIN WITH ROBLOX</button>
    </div>

    <div class="nav">
        <span>ADIYAN HUB</span>
        <div id="user-info"></div>
    </div>

    <div class="chat-box">
        <div id="msgs"></div>
        <div class="input-area">
            <input type="text" id="chatInput" placeholder="Type a message...">
            <button onclick="send()">SEND</button>
        </div>
    </div>

    <script>
        const ably = new Ably.Realtime('8_p8_w.Y-S57A:E-8j2q-u-S0S-O-T'); 
        const channel = ably.channels.get('global-chat');
        
        // LOGIN REDIRECT
        function login() {
            const clientID = "YOUR_CLIENT_ID"; // <--- PASTE CLIENT ID
            const redirect = encodeURIComponent("https://your-site.vercel.app/api/callback");
            location.href = `https://apis.roblox.com/oauth/v1/authorize?client_id=${clientID}&redirect_uri=${redirect}&scope=openid+profile&response_type=code`;
        }

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const user = params.get('username');
            const pic = params.get('avatar');

            if (user) {
                localStorage.setItem('rbx_user', user);
                localStorage.setItem('rbx_pic', pic);
                window.history.replaceState({}, "", "/discuss.html"); // Clean URL
            }

            const activeUser = localStorage.getItem('rbx_user');
            if (activeUser) {
                document.getElementById('overlay').style.display = 'none';
                document.getElementById('user-info').innerHTML = `
                    <img src="${localStorage.getItem('rbx_pic')}" style="width:30px; border-radius:50%; vertical-align:middle;">
                    ${activeUser} | <a href="#" onclick="localStorage.clear(); location.reload();" style="color:red; font-size:10px;">LOGOUT</a>
                `;
                
                channel.subscribe('msg', (m) => {
                    const d = document.createElement('div');
                    d.className = 'msg';
                    d.innerHTML = `<strong>${m.data.user}:</strong> ${m.data.text}`;
                    document.getElementById('msgs').appendChild(d);
                    document.getElementById('msgs').scrollTop = 9999;
                });
            }
        };

        function send() {
            const txt = document.getElementById('chatInput').value;
            if (txt) {
                channel.publish('msg', { user: localStorage.getItem('rbx_user'), text: txt });
                document.getElementById('chatInput').value = '';
            }
        }
    </script>
</body>
</html>
